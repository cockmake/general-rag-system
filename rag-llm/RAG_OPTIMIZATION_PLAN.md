# RAG 系统优化清单

基于对现有代码库的分析，以下是针对当前 RAG 系统的优化建议清单。这些建议旨在提高检索准确率、回答质量以及系统性能。

## 1. 数据入库与切分优化 (Data Ingestion)

### 🔥 启用切片重叠 (Critical)
*   **问题**: `mq/document_embedding.py` 中 PDF 和代码文件的切分显式设置了 `chunk_overlap=0`。
*   **影响**: 这会导致句子被截断，上下文丢失。例如，一个关键定义如果刚好在切分点，检索时可能只看到半句。
*   **建议**: 将 `chunk_overlap` 调整为 `100` 或 `200` (字符)。

### 🔥 修复文本合并时的粘连问题
*   **问题**: `utils.py` 中的 `pdf_split` 使用 `.replace('\n', '')` 直接删除换行符。
*   **影响**: 英文单词或段落可能发生粘连（如 `end.The` 变成 `end.The`），影响分词和向量化。
*   **建议**: 改为 `.replace('\n', ' ')`（替换为空格）。

### 元数据丰富 (Metadata)
*   **现状**: 仅存储了 `documentId` 和 `pk`。
*   **建议**: 增加 `file_name`、`chunk_index`、`total_chunks` 等元数据。这有助于前端展示引用来源，也方便未来做更精细的过滤。

## 2. 检索策略优化 (Retrieval Strategy)

### 🔥 提高召回数量 (Increase Recall)
*   **问题**: `rag_utils.py` 中 `top_k=5`。
*   **影响**: 召回范围太窄，Rerank 模型发挥空间不足。
*   **建议**: 将 `top_k` 提升至 `15` 或 `20`。让 Rerank 模型承担更多的筛选工作。

### 🔥 Rerank 阈值参数化
*   **问题**: `score_threshold=0.3` 是硬编码。
*   **建议**: 将阈值提取为配置项或允许从 API 透传，以便不同业务场景灵活调整（例如：精确问答需要高阈值，创意生成需要低阈值）。

### 混合检索 (Hybrid Search)
*   **现状**: 仅依赖向量检索。
*   **建议**: 引入关键词检索 (BM25)。对于专有名词、精确匹配（如错误码、具体型号）效果更好。

## 3. 系统性能与架构 (Performance)

### 🔥 Milvus 连接复用 (Connection Pooling)
*   **问题**: `rag_utils.py` (查询端) 和 `mq/document_embedding.py` (写入端) 每次操作都重新建立 Milvus 连接。
*   **影响**: 高并发下连接建立开销大，且可能耗尽资源。
*   **建议**: 封装全局单例的 Milvus 连接管理器，避免频繁握手开销。

### OCR 策略优化
*   **现状**: 对图片型 PDF 使用 OCR 提取。
*   **建议**: 增加超时机制或页数限制，防止处理超大扫描件时长时间阻塞 MQ 消费者线程。
